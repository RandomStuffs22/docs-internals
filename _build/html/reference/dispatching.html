
<!DOCTYPE html>

<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Orchestrating MVC &mdash; Phalcon 0.4.4 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/configurationblock.css" type="text/css" />
    <!--
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/layout.css" type="text/css" />
    -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Rosario" type="text/css">
    <!-- link rel="stylesheet" href="http://phalconphp.com/css/s.css" type="text/css" -->
    <link rel="stylesheet" href="../_static/s.css" type="text/css">    
    <link rel="stylesheet" href="../_static/docs.css" type="text/css">
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.4.4',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <!--<script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/configurationblock.js"></script>-->

    <script type="text/javascript">
    <!--
        $(document).ready(function() {
            $("#versions").change(function() {
                var docsUrl = $(this).val();
                window.location.href = docsUrl;
            });
        });
    -->
    </script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Phalcon 0.4.4 documentation" href="../index.html" />
    <link rel="next" title="Request Environment" href="request.html" />
    <link rel="prev" title="Routing" href="routing.html" /> 
  </head>
  <body>
    <div id="wrapper">

      <div id="header">        
        <h1><a href="http://phalconphp.com/index" ><img border="0" src="../_static/img/logo-small.png"></a></h1>
        <div align="center">
          <div id="nav-main" role="navigation">
            <div class="menubar">
              <div class="nav-main-features nav-first"><a href="http://phalconphp.com/index" >HOME</a></div>
              <div class="nav-main-features nav-first"><a href="http://phalconphp.com/download" >DOWNLOAD</a></div>
              <div class="nav-main-features"><a href="http://docs.phalconphp.com" >DOCUMENTATION</a></div>
              <div class="nav-main-features"><a href="https://groups.google.com/forum/#!forum/phalcon">SUPPORT</a></div>
              <div class="nav-main-features nav-first"><a href="https://github.com/phalcon/cphalcon">GITHUB</a></div>
              <div class="nav-main-features"><a target="blog" href="http://blog.phalconphp.com/">BLOG</a></div>
            </div>
          </div>
        </div>
      </div>
    <div class="related">      
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="request.html" title="Request Environment"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="routing.html" title="Routing"
             accesskey="P">previous</a> |</li>
        <li><a href="http://www.phalconphp.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon 0.4.4 documentation</a> &raquo;</li> 
      </ul>
    </div>  

      <table width="90%" align="center">
        <tr>
      <td class="primary-box" width="25%" valign="top">
            
            <div id="searchbox" style="">
              <h3>Search</h3>
                <form class="search" action="http://readthedocs.org/search/project/" method="get">
                  <input type="text" name="q" size="18">
                  <input type="submit" value="Go">
                  <input type="hidden" name="selected_facets" value="project:">
                </form>
            </div>
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Orchestrating MVC</a><ul>
<li><a class="reference internal" href="#understanding-the-default-behavior">Understanding the default behavior</a></li>
<li><a class="reference internal" href="#dispatch-loop">Dispatch Loop</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="routing.html"
                                  title="previous chapter">Routing</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="request.html"
                                  title="next chapter">Request Environment</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/reference/dispatching.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
        </td>
          <td class="second-box" valign="top">  
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                <div class="body" >
                      
  <div class="section" id="orchestrating-mvc">
<h1>Orchestrating MVC<a class="headerlink" href="#orchestrating-mvc" title="Permalink to this headline">¶</a></h1>
<p>All the hard work behind orchestrating the operation of MVC in Phalcon is normally done by <a class="reference internal" href="../api/Phalcon_Controller_Front.html"><em>Phalcon_Controller_Front</em></a>. This component encapsulates all the complex operations behind instantiating every component needed and integrating it with the rest to allow the MVC pattern to operate as desired.</p>
<div class="section" id="understanding-the-default-behavior">
<h2>Understanding the default behavior<a class="headerlink" href="#understanding-the-default-behavior" title="Permalink to this headline">¶</a></h2>
<p>If you&#8217;ve been following the <a class="reference external" href="tutorial">tutorials</a> or have generated the code using Tools, you may recognize the boostrap application like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="nv">$front</span> <span class="o">=</span> <span class="nx">Phalcon_Controller_Front</span><span class="o">::</span><span class="na">getInstance</span><span class="p">();</span>

    <span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon_Config_Adapter_Ini</span><span class="p">(</span><span class="s2">&quot;../app/config/config.ini&quot;</span><span class="p">);</span>
    <span class="nv">$front</span><span class="o">-&gt;</span><span class="na">setConfig</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>

    <span class="k">echo</span> <span class="nv">$front</span><span class="o">-&gt;</span><span class="na">dispatchLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">();</span>

<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Phalcon_Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;PhalconException: &quot;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The core of all the work of the controller occurs when dispatchLoop() is invoked:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">echo</span> <span class="nv">$front</span><span class="o">-&gt;</span><span class="na">dispatchLoop</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">();</span>
</pre></div>
</div>
<p>Internally and based on the config set, <a class="reference internal" href="../api/Phalcon_Controller_Front.html"><em>Phalcon_Controller_Front</em></a> performs the following steps for a request:</p>
<ul class="simple">
<li>Checks if a request instance has been previously set, otherwise, instantiates a <a class="reference internal" href="../api/Phalcon_Request.html"><em>Phalcon_Request</em></a> object</li>
<li>Checks if a response instance has been previously set, otherwise, instantiates a <a class="reference internal" href="../api/Phalcon_Response.html"><em>Phalcon_Response</em></a> object</li>
<li>Checks if a dispatcher instance has been set, otherwise, instantiates a <a class="reference internal" href="../api/Phalcon_Dispatcher.html"><em>Phalcon_Dispatcher</em></a> object. This object receives the controllersDir option set by config.</li>
<li>Checks if a router instance has been set, otherwise, instantiates a <a class="reference internal" href="../api/Phalcon_Router_Rewrite.html"><em>Phalcon_Router_Rewrite</em></a> object. By default the router will handle the URI placed at $_GET[&#8216;_url&#8217;]</li>
<li>Starts the view component. This enables output buffering by calling internally the function ob_start</li>
<li>The processed controller/action/parameters by the router is passed to the dispatcher.</li>
<li>The dispatcher locates the selected controller in the controllers directory, instantiates it and executes the action, passing the routing parameters to it</li>
<li>The view takes the last controller/action executed and renders the related views</li>
<li>The view returns all the buffered content</li>
<li>This content is passed to the response object</li>
</ul>
<p>You can of course not use <a class="reference internal" href="../api/Phalcon_Controller_Front.html"><em>Phalcon_Controller_Front</em></a> if you wish. The above example becomes:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Read the config</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon_Config_Adapter_Ini</span><span class="p">(</span><span class="s2">&quot;app/config/config.ini&quot;</span><span class="p">);</span>

<span class="c1">// Instantiate a router</span>
<span class="nv">$router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon_Router_Regex</span><span class="p">();</span>

<span class="c1">// Handle URI data</span>
<span class="nv">$router</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">();</span>

<span class="c1">// Instantiate both request and response objects</span>
<span class="nv">$request</span>  <span class="o">=</span> <span class="nx">Phalcon_Request</span><span class="o">::</span><span class="na">getInstance</span><span class="p">();</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nx">Phalcon_Response</span><span class="o">::</span><span class="na">getInstance</span><span class="p">();</span>

<span class="c1">// Instantiate View component setting views directory</span>
<span class="nv">$view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon_View</span><span class="p">();</span>
<span class="nv">$view</span><span class="o">-&gt;</span><span class="na">setBasePath</span><span class="p">(</span><span class="nv">$basePath</span><span class="p">);</span>
<span class="nv">$view</span><span class="o">-&gt;</span><span class="na">setViewsDir</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">phalcon</span><span class="o">-&gt;</span><span class="na">viewsDir</span><span class="p">);</span>

<span class="c1">// Instantiate Model Manager component setting models directory</span>
<span class="nv">$modelManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon_Model_Manager</span><span class="p">();</span>
<span class="nv">$modelManager</span><span class="o">-&gt;</span><span class="na">setBasePath</span><span class="p">(</span><span class="nv">$basePath</span><span class="p">);</span>
<span class="nv">$modelManager</span><span class="o">-&gt;</span><span class="na">setModelsDir</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">phalcon</span><span class="o">-&gt;</span><span class="na">modelsDir</span><span class="p">);</span>

<span class="c1">// Starts the view, also enabling output buffering</span>
<span class="nv">$view</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>

<span class="c1">// Instantiate a Dispatcher passing the proccesed parameters to it</span>
<span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phalcon_Dispatcher</span><span class="p">();</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setControllersDir</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="na">phalcon</span><span class="o">-&gt;</span><span class="na">controllersDir</span><span class="p">);</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setBasePath</span><span class="p">(</span><span class="nv">$basePath</span><span class="p">);</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setControllerName</span><span class="p">(</span><span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getControllerName</span><span class="p">());</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setActionName</span><span class="p">(</span><span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">());</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setParams</span><span class="p">(</span><span class="nv">$router</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">());</span>

<span class="c1">// Run the dispatch loop</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$response</span><span class="p">,</span> <span class="nv">$view</span><span class="p">,</span> <span class="nv">$modelManager</span><span class="p">);</span>

<span class="c1">// Takes the last controller/action and render its related views</span>
<span class="nv">$view</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getControllerName</span><span class="p">(),</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">(),</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">()</span>
<span class="p">);</span>
<span class="nv">$view</span><span class="o">-&gt;</span><span class="na">finish</span><span class="p">();</span>

<span class="c1">// Pass the buffered content to the response</span>
<span class="nv">$response</span><span class="o">-&gt;</span><span class="na">setContent</span><span class="p">(</span><span class="nv">$view</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">());</span>

<span class="c1">// Print out the response</span>
<span class="k">echo</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">getContent</span><span class="p">();</span>
</pre></div>
</div>
<p>As you can see the same operation can be done with fewer lines of code or with a more verbose way of coding. The above example might be preferred in cases where you need to have full control over the whole bootstrap process.</p>
</div>
<div class="section" id="dispatch-loop">
<h2>Dispatch Loop<a class="headerlink" href="#dispatch-loop" title="Permalink to this headline">¶</a></h2>
<p>The Dispatch Loop is another important process that has much to do with the MVC flow itself, especially with the controller part. The work occurs within the controller dispatcher. The controller files are read, loaded, instantiated, to then the required actions are executed. If an action forwards the flow to another controller/action, the controller dispatcher starts again. To better illustrate this, the following example shows approximately the process performed within <a class="reference internal" href="../api/Phalcon_Dispatcher.html"><em>Phalcon_Dispatcher</em></a>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Dispatch loop</span>
<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$finished</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$finished</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="nv">$controllerClass</span> <span class="o">=</span> <span class="nx">Phalcon_Text</span><span class="o">::</span><span class="na">camelize</span><span class="p">(</span><span class="nv">$controllerName</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;Controller&quot;</span><span class="p">;</span>

    <span class="c1">// Check if class is already loaded</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">class_exists</span><span class="p">(</span><span class="nv">$controllerClass</span><span class="p">))</span> <span class="p">{</span>

        <span class="nv">$controllerPath</span> <span class="o">=</span> <span class="nv">$controllersDir</span> <span class="o">.</span> <span class="nv">$controllerClass</span> <span class="o">.</span> <span class="s2">&quot;.php&quot;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$controllerPath</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">require</span> <span class="nv">$controllerPath</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Phalcon_Dispatcher_Exception</span><span class="p">(</span>
                <span class="s2">&quot;File for controller class &quot;</span> <span class="o">.</span> <span class="nv">$controllerClass</span> <span class="o">.</span> <span class="s2">&quot; doesn&#39;t exist&quot;</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">class_exists</span><span class="p">(</span><span class="nv">$controllerClass</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Phalcon_Dispatcher_Exception</span><span class="p">(</span>
                <span class="s2">&quot;Class &quot;</span> <span class="o">.</span> <span class="nv">$controllerClass</span> <span class="o">.</span> <span class="s2">&quot; was not found in the controller file&quot;</span>
            <span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="c1">// Instantiate the controller passing the</span>
    <span class="c1">// request/response/view/model-manager objects</span>
    <span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$controllerClass</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$response</span><span class="p">,</span> <span class="nv">$view</span><span class="p">,</span> <span class="nv">$model</span><span class="p">);</span>

    <span class="c1">// Execute the action</span>
    <span class="nb">call_user_func_array</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$controller</span><span class="p">,</span> <span class="nv">$actionName</span> <span class="o">.</span> <span class="s2">&quot;Action&quot;</span><span class="p">),</span> <span class="nv">$params</span><span class="p">);</span>

    <span class="c1">// Finished should be reloaded to check if the flow was forwarded to another controller</span>
    <span class="c1">// $finished = false;</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The code above lacks validations, filters and additional checks, but it demonstrates the normal flow of operation in the dispatcher.</p>
</div>
</div>


                    </div>
                  </div>
                </div>          
            </div>
          </td>  
        </tr>   
      </table>
    <div class="related">      
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="request.html" title="Request Environment"
             >next</a> |</li>
        <li class="right" >
          <a href="routing.html" title="Routing"
             >previous</a> |</li> 
      </ul>
    </div>
        <div id="footer">
             &copy; Copyright 2012, Phalcon Team.
             Last updated on Aug 30, 2012.
            Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
        </div>

    </div>

  </body>
</html>